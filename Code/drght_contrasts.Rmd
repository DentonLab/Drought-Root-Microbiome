---
Differential abundance analysis
---

This code performs the differential abundance analysis to detect the phyla and OTUs that are differentially abundant between watering regimes, as well as those differentially abundant between rhizosphere and endopshere under well-watered conditions

This script requires the files generated by the following scripts:
OTU_filtering.Rmd 

Load the libraries
```{r}
# Set workind directory and load libraries 

library(BiocParallel)
library(DESeq2)
library(biobroom)
library(dplyr)
library(tidyr)
```

Load the data and format it to fit DESeq2 requirements
```{r}
map <- readRDS("../Data/map.RDS")

otu <- readRDS("../Data/otu_filt.RDS")
phycla <- readRDS("../Data/phycla_all.RDS")

# Subset and format
# Because we are interested in detecting the drought effect within compartments and soils, we grouped these variables together
map <- map %>% 

    mutate(Group = paste(Soil, Compartment, Treatment, sep = "."))

row.names(map) <- map$SampleID

otu <- otu[,match(map$SampleID, colnames(otu))]
phycla <- phycla[,match(map$SampleID, colnames(phycla))]
```

Run DESeq
```{r}
#This is for looping 

ranks <- c("PhyClass", "OTU")
ranks.list <- list(PhyClass = phycla,
                   OTU = otu)
res.list <- vector("list")

for(r in ranks){
  
  dds <- DESeqDataSetFromMatrix(countData = ranks.list[[r]],
                                colData = map,
                                design = ~ Group + Library)
  

  dds <- DESeq(dds)
  
  contrasts = c("A.BS", "A.RS", "A.ES",
                "B.BS", "B.RS", "B.ES",
                "D.BS", "D.RS", "D.ES",
                "A.WC", "B.WC", "D.WC") 
  
  ## The first nine contrasts assess the drought effect 
  ## The last three contrasts assess if the OTUs are differentially abundant between rhizosphere and endosphere

  
  contrast.list <- list(A.BS = c("Group", "A.BS.DS", "A.BS.WC"),
                        B.BS = c("Group", "B.BS.DS", "B.BS.WC"),
                        D.BS = c("Group", "D.BS.DS", "D.BS.WC"),
                        A.RS = c("Group", "A.RS.DS", "A.RS.WC"),
                        A.ES = c("Group", "A.ES.DS", "A.ES.WC"),
                        B.RS = c("Group", "B.RS.DS", "B.RS.WC"),
                        B.ES = c("Group", "B.ES.DS", "B.ES.WC"),
                        D.RS = c("Group", "D.RS.DS", "D.RS.WC"),
                        D.ES = c("Group", "D.ES.DS", "D.ES.WC"),
                        A.WC = c("Group", "A.ES.WC", "A.RS.WC"), 
                        B.WC = c("Group", "B.ES.WC", "B.RS.WC"),
                        D.WC = c("Group", "D.ES.WC", "D.RS.WC"))
  
  # We are using the Bonferroni correction for dealing with multiple comparisons
  
  for(i in contrasts) {
    res.list[[paste(r,i,sep = ".")]] <- tidy(results(dds, contrast = contrast.list[[i]], pAdjustMethod = "bonferroni"))
  }
}

```

Format the results

```{r}
df <- plyr::ldply(res.list, function(x) x)
names(df)[1] <- "Contrast"
names(df)[2] <- "OTU_ID"
  
df <- df %>%
  separate(Contrast, c("Rank", "Soil", "Compartment"), sep = "\\.") 
  

saveRDS(df, "../Tables/dab_drought.RDS")
```
