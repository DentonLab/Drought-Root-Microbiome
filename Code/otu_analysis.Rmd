---
OTU-level analysis
---

This script requires the files generated by the following scripts:
OTU_filtering.Rmd
drght_contrasts.Rmd

Load the libraries and functions needed for the analysis
```{r}
setwd("~/Documents/RiceMB/Drought/Paper/Main_Exp/Code")
library(dplyr)
library(ggplot2)
library(tidyr)
library(RColorBrewer)
library(VennDiagram)
library(scales)

# Some plots will require reordering data within facets. David Robinson has written a couple of functions to implement this in ggplot2. 
# https://github.com/dgrtwo/drlib/blob/master/R/reorder_within.R
reorder_within <- function(x, by, within, fun = mean, sep = "___", ...) {
  new_x <- paste(x, within, sep = sep)
  stats::reorder(new_x, by, FUN = fun)
}

scale_x_reordered <- function(..., sep = "___") {
  reg <- paste0(sep, ".+$")
  ggplot2::scale_x_discrete(labels = function(x) gsub(reg, "", x), ...)
}

scale_y_reordered <- function(..., sep = "___") {
  reg <- paste0(sep, ".+$")
  ggplot2::scale_y_discrete(labels = function(x) gsub(reg, "", x), ...)
}

```

Load the files required
```{r}
otu <- readRDS("../Data/otu_filt.RDS")
tax <- readRDS("../Data/tax.RDS")
map <- readRDS("../Data/map.RDS")
wt <- readRDS("../Tables/dab_drought.RDS")
#Discard the contrast testing for differential abundance between compartments under well-watered conditions
wt <- filter(wt, Compartment != "WC")
```


Subset to only include significant OTUs (P < 0.05)
```{r}
wt.sig <- wt %>%
  filter(Rank == "OTU") %>%
  filter(p.adjusted < 0.05) 

wt.sig %>% 
  inner_join(tax, by = "OTU_ID") %>%
  group_by(Phylum) %>%
  count() %>%
  arrange(desc(n)) %>%
  head(n = 10)

```

Identify the number of phyla, classes, orders, and families encompassed by the set of differentially abundant OTUs.
Since some of the OTUs are not classified at different taxonomic ranks, we'll discard those before estimating the taxonomic spread of the drought response. 
```{r}
wt.sig.table <- wt.sig %>%
  inner_join(tax, by = "OTU_ID") 

write.table(wt.sig.table, "../Tables/16S_dab.tsv", sep = "\t", quote = F)

drght_resp <- wt.sig.table %>%
  mutate(Response = ifelse(estimate > 0, "Drought-enriched", "Drought-depleted")) %>%
  group_by(Response) %>%
  count()

tax_resp <- wt.sig.table %>%
  select(Phylum, Class, Order, Family) %>%
  gather(key = "Rank", value = "Taxon") %>%
  filter(Taxon != "unassigned" & Taxon != "unclassified") %>%
  group_by(Rank, Taxon) %>%
  count() %>%
  group_by(Rank) %>%
  count()

drght_resp; tax_resp
````

Plot the number of differentially abundant OTUs detected in each soil and compartment, as well as the cumulative relative abundances of those OTUs under controlled and drought-stressed conditions. 
```{r}

# Calculate the relative abundances and reformat
otu.ra <- t(t(otu)/colSums(otu))

otu.ra.tidy <- data.frame(otu.ra) %>%
  mutate(OTU_ID = row.names(otu.ra)) %>%
  gather(key = "SampleID", value = "RelAb", -OTU_ID)

# Calculate the cumulative relative abundances 
otu.cmp.soi <- otu.ra.tidy %>%
  inner_join(map, by = "SampleID") %>%
  group_by(Compartment, Soil, Treatment) %>%
  mutate(Total = sum(RelAb)) %>%
  group_by(Compartment, Soil, Treatment, OTU_ID,Total) %>%
  summarise(TotRelAb = sum(RelAb)) %>%
  mutate(TotRelAb = TotRelAb/Total) %>%
  ungroup() %>%
  select(Compartment, Soil, OTU_ID, TotRelAb, Treatment)

# Get the C.R.A of the differentially abundant OTUs and reformat
cra.otu <- wt.sig %>%
  inner_join(otu.cmp.soi, by = c("Compartment", "Soil", "OTU_ID")) %>%
  mutate(Enrichment = ifelse(estimate > 0, "Enrichment", "Depletion")) %>%
  group_by(Compartment, Soil, Treatment, Enrichment) %>%
  summarise(nOTU = sum(p.adjusted < 0.05),
         CRA = sum(TotRelAb))

cra.otu$Compartment = factor(cra.otu$Compartment,
                         levels = c("BS","RS", "ES"),
                        labels = c("Bulk Soil", "Rhizosphere", "Endosphere"))
cra.otu$Soil = factor(cra.otu$Soil,
                  levels = c("A", "B", "D"),
                      labels = c("Arbuckle", "Biggs", "Davis"))

# Plot

cra.theme <- list(theme(text = element_text(size = 20),
                    axis.text.x = element_text(angle = 45, hjust = 1),
                    axis.title.x = element_text(size = 0),
                    axis.line.x = element_line(colour = "black"),
                    axis.line.y = element_line(colour = "black"),
                    panel.spacing = unit(0.5, "lines"),
                    panel.border = element_blank(),
                    legend.position = "bottom"))
cra.scale <- list(scale_fill_manual(name = "Drought\nResponse",
                                    values = c("#5AB4AC", "#D8B365")))
cra.guide <- list(guides(fill = guide_legend(ncol = 1,
                                             title.position = "top")))


wc.cra <- ggplot(filter(cra.otu, Treatment == "WC"), aes(Compartment, CRA, fill = Enrichment)) +
  geom_bar(stat = "identity") +
  facet_grid(.~ Soil) +
  labs(y = "Cum. Rel. Ab.\n(Control)") +
  theme_light() +
  cra.theme +
  cra.scale +
  cra.guide


ds.cra <- ggplot(filter(cra.otu, Treatment == "DS"), aes(Compartment, CRA, fill = Enrichment)) +
  geom_bar(stat = "identity") +
  facet_grid(.~ Soil) +
  labs(y = "Cum. Rel. Ab.\n(Drought)") +
  theme_light() +
  cra.theme +
  cra.scale +
  cra.guide
 
dab.otu <- ggplot(filter(cra.otu, Treatment == "DS"), aes(Compartment, nOTU, fill = Enrichment)) +
  geom_bar(stat = "identity") +
  facet_grid(.~ Soil) +
  labs(y = "Number of OTUs") +
  theme_light() +
  cra.theme +
  cra.scale +
  cra.guide

dab.otu; wc.cra; ds.cra

```

Make the files necessary to generate the graphlan dendogram
```{r}

# Define the general parameters of the dendogram
ring.global <- data.frame(OTU_ID2 = c(rep("ring_internal_separator_thickness", 4), 
                                     rep("ring_external_separator_thickness", 4),
                                     rep("ring_separator_color", 4)),
                          Parameter = c(rep(c(1,2,3,4),3)),
                          Ring = c(rep(2.0, 8), rep("white",4)),
                          Color = rep("",12))

global.annot <-  data.frame(Taxon = c("annotation_background_alpha", "total_plotted_degrees", "start_rotation", "branch_color", "branch_color_from_ancestor", "clade_marker_edge_width", "clade_marker_edge_color","clade_marker_size"),
               Parameter = c("0.8", "345", "270", "#CCCCCC", "0","0", "#CCCCCC","80"),
               Value = c("","","","","","","",""))

# Generate the data.frame that will be used to generate the rest of the annotation files

phy.colors <- data.frame(PhyClass = c("Acidobacteria",
                                    "Actinobacteria",
                                    "Bacteroidetes",
                                    "Chloroflexi",
                                    "Firmicutes",
                                    "Gemmatimonadetes",
                                    "Planctomycetes",
                                    "Verrucomicrobia",
                                    "Proteobacteria.Alphaproteobacteria",
                                    "Proteobacteria.Betaproteobacteria",
                                    "Proteobacteria.Deltaproteobacteria",
                                    "Proteobacteria.Gammaproteobacteria"),
                      ring_color.1 =  c(brewer.pal(8, "Set2")[1:8], brewer.pal(11, "RdYlBu")[7:10]))


wt.top <- wt.sig %>% 
  inner_join(tax, by = "OTU_ID") %>%
  group_by(Phylum) %>%
  count() %>%
  arrange(desc(n)) %>%
  head(n = 10)

wt.master <- wt.sig %>%
  group_by(OTU_ID) %>%
  count() %>%
  inner_join(tax, by = "OTU_ID") %>%
  mutate(OTU_ID2 = paste("OTU", 1:nrow(.), sep = "-")) %>%
  filter(Kingdom != "unassigned") %>%
  filter(Phylum %in% wt.top$Phylum) %>%
  mutate(Class2 = paste(Phylum, Class, sep = "_")) %>%
  mutate(Order2 = paste(Phylum, Class, Order, sep = "_")) %>%
  mutate(Family2 = paste(Phylum, Class, Order, Family, sep = "_")) %>%
  mutate(Tax = paste(Phylum, Class2, Order2, Family2, OTU_ID2, sep = ".")) %>%
  inner_join(wt.sig, by = "OTU_ID") %>% 
  mutate(group = Compartment) %>%
  mutate(Ring = factor(group,
                              levels = c("RS", "ES", "BS"),
                              labels = c("2", "3", "4"))) %>%
  inner_join(phy.colors, by = "PhyClass")

# Generate the tree file

perc.tree <- wt.master %>%
  group_by(Tax) %>%
  count()

write.table(select(perc.tree,Tax), "../graphlan/perc.tree", quote = FALSE, row.names = FALSE, col.names = FALSE) 

# Generate the annotation file

# This defines the size of the inner nodes
clade_size <- wt.master %>%
  select(Phylum, Class2, Order2, Family2, OTU_ID2) %>%
  gather(key = "Rank", value = "Taxon") %>%
  group_by(Rank, Taxon) %>%
  count() %>%
  ungroup() %>%
  mutate(Parameter = "clade_marker_size",
         Value = ifelse(Rank == "Phylum", "80",
                        ifelse(Rank == "Class2", "60",
                               ifelse(Rank == "Order2", "40",
                                      ifelse(Rank == "Family2", "20", "5"))))) %>%
    select(Taxon, Parameter, Value)

# This defines the color of the inner nodes
clade_color <- wt.master %>%
  select(Phylum, Class2, Order2, Family2, OTU_ID2, estimate) %>%
  gather(key = "Rank", value = "Taxon", -estimate) %>%
  group_by(Taxon) %>%
  summarise(nDrought = sum(estimate < 0),
            Total = sum(estimate != 0)) %>%
  mutate(Percent_Drought = nDrought/Total) %>%
  mutate(clade_marker_color = col_numeric(brewer.pal(11,"RdYlBu")[2:10], domain = 0:1)(Percent_Drought)) %>%
  select(Taxon, clade_marker_color) %>%
  gather(key = "Parameter", value = "Value", -Taxon)  

# Put everything together
perc.annot <- rbind(global.annot,clade_color,clade_size)

write.table(perc.annot, "../graphlan/perc.annot", quote = FALSE, row.names = FALSE, sep = "\t", col.names = FALSE) 

#Generate the ring file

# This generates the overlap outer rings
overlap.color <- data.frame(Overlap = -3:3, Color = c("#01665E", "#35978F", "#80CDC1", "gray", "#DFC27D", "#BF812D", "#8C510A"))

overlap.ring <- wt.master %>%
  group_by(Compartment, OTU_ID2) %>%
  summarise(DS = sum(estimate > 0),
            WC = -sum(estimate < 0)) %>%
  mutate(Overlap = ifelse((DS == 0 | WC == 0), DS + WC, as.integer(0))) %>%
  inner_join(overlap.color, by = "Overlap") %>%
  ungroup() %>%
  mutate(Parameter = "ring_color",
         Ring = ifelse(Compartment == "RS","2",ifelse(Compartment == "ES", "3", "4"))) %>%
  select(OTU_ID2, Parameter, Ring, Color)

# This generates the phylum inner ring
phy.ring <- wt.master %>%
  group_by(OTU_ID2, ring_color.1) %>%
  count() %>%
  select(OTU_ID2,ring_color.1) %>%
  gather(key = "Parameter", value = "Color", -OTU_ID2) %>%
  separate(Parameter, c("Parameter","Ring"), sep = "\\.") %>%
  select(OTU_ID2, Parameter, Ring, Color)
  
perc.ring <- rbind(data.frame(ring.global), data.frame(overlap.ring), data.frame(phy.ring))

write.table(perc.ring, "../graphlan/perc.ring", quote = FALSE, row.names = FALSE, sep = "\t", col.names = FALSE) 
```


Generate the plot showing the taxonomies most highly represented in the set of differentially abundant OTUs
```{r}
# This generates the data frame that will be used for plotting. We will select only the 8 most highly represented taxa within each rank
tmp <- wt.master %>%
  mutate(Enrichment = ifelse(estimate > 0, "Drought-enriched", "Drought-depleted")) %>%
  select(Phylum, Class, Order, Family, PhyClass, Compartment, Soil, Enrichment) %>%
  gather(key = "Rank", value = "Taxon", Phylum:Family) %>%
  filter(Taxon != "unclassified") %>%
  mutate(PhyClass = ifelse(Taxon == "Proteobacteria", NA, PhyClass)) %>%
  group_by(Compartment, Soil, Enrichment, Rank, PhyClass, Taxon) %>%
  count() 

tax.plot.df <- tmp %>%
  group_by(Compartment, Enrichment, Rank, Taxon) %>%
  summarise(Total = sum(n)) %>%
  group_by(Compartment, Enrichment, Rank)%>%
  mutate(Ordering = rank(-Total, ties.method = "random")) %>%
  inner_join(tmp, by = c("Compartment", "Enrichment", "Rank", "Taxon")) %>%
  filter(Ordering <= 8) %>%
  filter(Compartment != "BS") 

tax.plot.df$Soil <- factor(tax.plot.df$Soil,
                         levels = c("A", "B", "D"),
                         labels = c("Arbuckle", "Biggs", "Davis"))

#This is just a hack to keep the right order when facetting. There's probably a better way to do this. 
tax.plot.df$Rank <- factor(tax.plot.df$Rank,
                         levels = c("Phylum", "Class", "Order", "Family"),
                         labels = c("1Phylum", "2Class", "3Order", "4Family"))

tax.plot.df$Compartment <- factor(tax.plot.df$Compartment,
                                levels = c("RS", "ES"),
                                labels = c("1RS", "2ES"))

tax.plot.df <- tax.plot.df%>%
  mutate(Facet = paste(Rank, Enrichment, Compartment))

# Reorder the taxa so that Proteobacteria are at the end, and generate new labels

tax.plot.df$PhyClass <- factor(tax.plot.df$PhyClass,
                           levels = c("Acidobacteria",
                "Actinobacteria",
                "Bacteroidetes",
                "Chloroflexi",
                "Firmicutes",
                "Gemmatimonadetes",
                "Planctomycetes",
                "Verrucomicrobia",
                "Proteobacteria.Alphaproteobacteria",
                "Proteobacteria.Betaproteobacteria",
                "Proteobacteria.Deltaproteobacteria",
                "Proteobacteria.Gammaproteobacteria"))

my.labs <- list("Acidobacteria",
                "Actinobacteria",
                "Bacteroidetes",
                "Chloroflexi",
                "Firmicutes",
                "Gemmatimonadetes",
                "Planctomycetes",
                "Verrucomicrobia",
                expression(paste(alpha, " - Proteobacteria")),
                expression(paste(beta, " - Proteobacteria")),
                expression(paste(delta, " - Proteobacteria")),
                expression(paste(gamma, " - Proteobacteria")))

# This is to provide the right colored dot next to the bars
master.tax <- data.frame(PhyClass = c("Acidobacteria",
                "Actinobacteria",
                "Bacteroidetes",
                "Chloroflexi",
                "Firmicutes",
                "Gemmatimonadetes",
                "Planctomycetes",
                "Proteobacteria.Alphaproteobacteria",
                "Proteobacteria.Betaproteobacteria",
                "Proteobacteria.Deltaproteobacteria",
                "Proteobacteria.Gammaproteobacteria",
                "Verrucomicrobia"),
                Color = c(brewer.pal(8, "Set2")[1:8], brewer.pal(11, "RdYlBu")[7:10]))

master.tax <- filter(master.tax, PhyClass %in% tax.plot.df$PhyClass)

tax.plot <- ggplot(tax.plot.df, aes(reorder_within(Taxon, -Ordering, Facet), n, fill = Soil)) +
  geom_bar(stat = "identity", size = 1) +
  scale_fill_manual(values = brewer.pal(9, "Greys")[c(4,6,8)]) +
  geom_point(data = tax.plot.df, aes(reorder_within(Taxon, -Ordering, Facet), 0, color = PhyClass), size = 5) +
  scale_color_manual(name = "Phylum",
                     values = as.character(master.tax$Color),
                     labels = my.labs) + 
  facet_wrap( ~ Facet, scales = "free") +
  coord_flip() +
  scale_x_reordered() +
  labs(y = "Number of drought responsive OTUs") +
  
  theme_light() +
  theme(axis.title.y = element_blank(),
        text = element_text(size = 15),
        strip.text = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        legend.position = "bottom") +
   guides(fill = guide_legend(nrow = 3))
  
tax.plot

```

Generate the percentage plot showing the coherence within certain taxa across multiple ranks
```{r}
# This generates the data frame that will be used for plotting
perc.plot <- wt.master %>%
  select(Phylum, Class, Order, Family, PhyClass, estimate) %>%
  gather(key = "Rank", value = "Taxon", Phylum:Family) %>%
  mutate(PhyClass = ifelse(Rank == "Phylum" & Taxon == "Proteobacteria", NA, PhyClass)) %>%
  group_by(Rank, PhyClass, Taxon) %>%
  summarise(nDrought = sum(estimate > 0),
            Total = sum(estimate != 0)) %>%
  mutate(Enrichment = nDrought/Total) %>%
  mutate(Depletion = 1 - Enrichment) %>%
  mutate(PlotOrder = Enrichment) %>%
  filter(Taxon != "unclassified") %>%
  filter(Total > 15) %>%
  gather(key = "Direction", value = "Percent", Enrichment:Depletion)


perc.plot$Rank <- factor(perc.plot$Rank,
                         levels = c("Phylum", "Class", "Order", "Family"))

# This is for generating the right colored dots next to the barplots

master.tax <- data.frame(PhyClass = c("Acidobacteria",
                "Actinobacteria",
                "Bacteroidetes",
                "Chloroflexi",
                "Firmicutes",
                "Gemmatimonadetes",
                "Planctomycetes",
                "Proteobacteria.Alphaproteobacteria",
                "Proteobacteria.Betaproteobacteria",
                "Proteobacteria.Deltaproteobacteria",
                "Proteobacteria.Gammaproteobacteria",
                "Verrucomicrobia"),
                Color = c(brewer.pal(8, "Set2")[1:7], brewer.pal(11, "RdYlBu")[7:10], brewer.pal(8, "Set2")[8]))

master.tax <- filter(master.tax, PhyClass %in% perc.plot$PhyClass)

# Plot 
ggplot(perc.plot, aes(reorder_within(Taxon, -PlotOrder, Rank), Percent, fill = Direction)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "Drought\nResponse",
                    values = brewer.pal(9, "Greys")[c(4,7)]) +
  geom_point(data = perc.plot, aes(reorder_within(Taxon, -PlotOrder, Rank), - 0.05, color = PhyClass), size = 3) +
  scale_color_manual(values = as.character(master.tax$Color),
                     guide = FALSE) +
  facet_grid(Rank~., scales = "free", space = "free") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) +
  scale_x_reordered() +
  geom_hline(yintercept = .90, color = "white", linetype = 2) +
  geom_hline(yintercept = .1, color = "white", linetype = 2) +
  ylab("% OTUs") +
  theme(axis.title.y = element_blank(),
        text = element_text(size = 15),
        strip.text = element_text(size = 20),
        legend.text = element_text(size = 17),
        legend.title = element_text(size = 20),
        legend.position = "bottom") +
  coord_flip() +
  guides(fill = guide_legend(nrow = 2))

  
  
```

Generate the Venn diagrams showing the overlap between the rhizosphere and endosphere drought response. Just change the specific soil to generate the corresponding set. 
```{r}
otu.sig <- filter(wt.sig, Soil == "A")
  
rs.ds <- filter(otu.sig,Compartment == "RS" & estimate > 0) %>% select(OTU_ID)
es.ds <- filter(otu.sig,Compartment == "ES" & estimate > 0) %>% select(OTU_ID)
rs.wc <- filter(otu.sig,Compartment == "RS" & estimate < 0) %>% select(OTU_ID)
es.wc <- filter(otu.sig,Compartment == "ES" & estimate < 0) %>% select(OTU_ID)

venn.diagram(list(RS = rs.ds$OTU_ID, 
                  ES = es.ds$OTU_ID),
             filename = "../Plots/arb.ds.tiff",
             lty = "blank",
             fill = c("#FB8072", "#80B1D3"), 
             cex = 3.5,
             main.cex = 0,cat.dist = -0.60,
             cat.cex = 0,
             alpha = 0.6)

venn.diagram(list(RS = rs.wc$OTU_ID, 
                  ES = es.wc$OTU_ID),
             filename = "../Plots/arb.wc.tiff",
             lty = "blank",
             fill = c("#FB8072", "#80B1D3"), 
             cex = 3.5,
             main.cex = 0,cat.dist = -0.60,
             cat.cex = 0,
             alpha = 0.6)
```
